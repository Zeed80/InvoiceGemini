# План исправления ошибок и улучшений InvoiceGemini

## Обнаруженные проблемы

### 1. Критические ошибки

#### 1.1 Обработка ошибок
- **Проблема**: Использование `print()` вместо логирования в exception handlers
- **Файлы**: app/threads.py, app/main_window.py, app/processing_engine.py
- **Решение**: Заменить все print на logger с правильным уровнем логирования

#### 1.2 Управление памятью
- **Проблема**: Отсутствие проверки доступной памяти перед загрузкой моделей
- **Файлы**: app/processing_engine.py (ModelManager)
- **Решение**: Интегрировать MemoryManager во все места загрузки моделей

#### 1.3 Обработка импортов
- **Проблема**: Множественные ImportError не обрабатываются корректно
- **Файлы**: Большинство модулей плагинов
- **Решение**: Добавить graceful degradation и информативные сообщения

### 2. Проблемы с плагинами

#### 2.1 LLM плагины
- **Проблема**: Отсутствие валидации API ключей перед использованием
- **Файлы**: app/plugins/models/*.py
- **Решение**: Добавить проверку и шифрование ключей через SecretsManager

#### 2.2 Инициализация плагинов
- **Проблема**: Плагины не проверяют зависимости перед загрузкой
- **Файлы**: app/plugins/base_plugin.py, plugin_manager.py
- **Решение**: Добавить метод check_dependencies()

### 3. UI проблемы

#### 3.1 Thread safety
- **Проблема**: UI обновления из worker threads
- **Файлы**: app/threads.py, app/main_window.py
- **Решение**: Использовать сигналы для всех UI обновлений

#### 3.2 Валидация входных данных
- **Проблема**: Отсутствует валидация путей файлов и форматов
- **Файлы**: app/main_window.py (process_file, process_folder)
- **Решение**: Добавить проверки перед обработкой

### 4. Проблемы с моделями

#### 4.1 Загрузка моделей
- **Проблема**: Модели загружаются без проверки существования файлов
- **Файлы**: app/processing_engine.py
- **Решение**: Добавить проверку путей и fallback механизмы

#### 4.2 OCR обработка
- **Проблема**: OCR падает если Tesseract не установлен
- **Файлы**: app/processing_engine.py (OCRProcessor)
- **Решение**: Добавить проверку и альтернативные методы

### 5. Проблемы с данными

#### 5.1 Парсинг JSON
- **Проблема**: JSON парсинг без обработки невалидных данных
- **Файлы**: app/plugins/base_llm_plugin.py
- **Решение**: Добавить robust JSON parsing с fallback

#### 5.2 Сохранение результатов
- **Проблема**: Экспорт падает если pandas не установлен
- **Файлы**: app/main_window.py (save_excel)
- **Решение**: Добавить альтернативные методы экспорта

## План реализации

### Фаза 1: Критические исправления (1-2 дня)

1. **Исправить обработку ошибок**
   - Заменить все print на logger
   - Добавить try-except во все критические места
   - Реализовать централизованную обработку ошибок

2. **Исправить управление памятью**
   - Интегрировать MemoryManager во все модели
   - Добавить проверки перед загрузкой
   - Реализовать выгрузку неиспользуемых моделей

3. **Исправить thread safety**
   - Использовать сигналы для UI обновлений
   - Добавить блокировки где необходимо
   - Проверить все worker threads

### Фаза 2: Улучшение плагинов (2-3 дня)

1. **Улучшить систему плагинов**
   - Добавить валидацию зависимостей
   - Реализовать graceful degradation
   - Улучшить обработку ошибок

2. **Защитить API ключи**
   - Использовать SecretsManager везде
   - Добавить валидацию ключей
   - Шифровать все sensitive данные

3. **Улучшить LLM плагины**
   - Добавить retry механизмы
   - Улучшить парсинг ответов
   - Добавить кэширование

### Фаза 3: Улучшение UI (1-2 дня)

1. **Улучшить валидацию**
   - Проверять все входные данные
   - Добавить информативные сообщения
   - Предотвратить некорректные операции

2. **Улучшить отзывчивость**
   - Добавить progress indicators везде
   - Реализовать отмену операций
   - Улучшить feedback пользователю

3. **Исправить preview dialog**
   - Обработать все edge cases
   - Добавить валидацию данных
   - Улучшить отображение ошибок

### Фаза 4: Улучшение моделей (1-2 дня)

1. **Улучшить загрузку моделей**
   - Добавить проверку файлов
   - Реализовать автоматическую загрузку
   - Добавить progress tracking

2. **Улучшить OCR**
   - Добавить fallback методы
   - Улучшить обработку PDF
   - Оптимизировать производительность

3. **Улучшить обработку результатов**
   - Добавить валидацию JSON
   - Улучшить нормализацию данных
   - Добавить confidence scores

## Приоритеты

1. **Высокий приоритет**
   - Исправить критические ошибки
   - Защитить API ключи
   - Исправить thread safety

2. **Средний приоритет**
   - Улучшить систему плагинов
   - Добавить валидацию данных
   - Улучшить UI отзывчивость

3. **Низкий приоритет**
   - Оптимизация производительности
   - Дополнительные features
   - Косметические улучшения 