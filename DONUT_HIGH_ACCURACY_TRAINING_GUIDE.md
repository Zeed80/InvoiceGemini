# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–±—É—á–µ–Ω–∏—é Donut —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é > 98%

## üéØ –¶–µ–ª—å
–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª–µ–π –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ > 98% —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ Donut.

## üìä –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **–ú–µ—Ç—Ä–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è**
- ‚ùå **–ë—ã–ª–æ**: BLEU/ROUGE –º–µ—Ç—Ä–∏–∫–∏ (–¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞)
- ‚úÖ **–°—Ç–∞–ª–æ**: –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª–µ–π:
  - F1-score –ø–æ –ø–æ–ª—è–º
  - Document accuracy (–ø—Ä–æ—Ü–µ–Ω—Ç –∏–¥–µ–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
  - Exact match rate (–ø—Ä–æ—Ü–µ–Ω—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π)

### 2. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö**
- ‚ùå **–ë—ã–ª–æ**: –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
- ‚úÖ **–°—Ç–∞–ª–æ**: 
  - DataQualityEnhancer —Å –∫–æ–Ω—Å–µ–Ω—Å—É—Å-–∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏
  - IntelligentDataExtractor –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π (> 95%)

### 3. **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**
- ‚ùå **–ë—ã–ª–æ**: –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç "–ò–∑–≤–ª–µ–∫–∏ –≤—Å–µ –ø–æ–ª—è –∏–∑ —Å—á–µ—Ç–∞"
- ‚úÖ **–°—Ç–∞–ª–æ**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —Ç–µ–≥–∞–º–∏ `<s_field>value</s_field>`

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞

```python
from app.training.enhanced_donut_trainer import EnhancedDonutTrainer
from app.config import AppConfig
from app.gemini_processor import GeminiProcessor
from app.utils import OCRProcessor

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
app_config = AppConfig()
ocr_processor = OCRProcessor()
gemini_processor = GeminiProcessor(app_config)

trainer = EnhancedDonutTrainer(app_config)

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞ —Å –∫–∞—á–µ—Å—Ç–≤–æ–º > 98%
dataset = trainer.prepare_high_quality_dataset(
    source_folder="data/training_documents",
    ocr_processor=ocr_processor,
    gemini_processor=gemini_processor
)
```

### 2. –û–±—É—á–µ–Ω–∏–µ —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

```python
# –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
training_args = {
    'num_train_epochs': 20,           # –ë–æ–ª—å—à–µ —ç–ø–æ—Ö –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è
    'per_device_train_batch_size': 2,
    'gradient_accumulation_steps': 8, # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size = 16
    'learning_rate': 1e-5,           # –ú–µ–Ω—å—à–µ LR –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    'weight_decay': 0.05,
    'warmup_ratio': 0.15,
    'max_length': 768,               # –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    'image_size': 448,               # –í—ã—à–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
    'fp16': True,                    # –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ GPU
    'gradient_checkpointing': True,   # –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏
    'label_smoothing_factor': 0.1    # –õ—É—á—à–∞—è –≥–µ–Ω–µ—Ä–∞–ª–∏–∑–∞—Ü–∏—è
}

# –û–±—É—á–µ–Ω–∏–µ
output_path = trainer.train_high_accuracy_donut(
    dataset=dataset,
    base_model_id="naver-clova-ix/donut-base-finetuned-cord-v2",
    output_model_name="invoice_extractor_98plus",
    training_args=training_args
)
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

```python
from app.training.donut_model_tester import DonutModelTester

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
tester = DonutModelTester(output_path)
tester.load_model()

results = tester.test_on_dataset(
    test_data_path="data/test_invoices",
    ground_truth_path="data/test_ground_truth.json"
)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
passed = tester.validate_model_quality()
```

## üìà –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 98%+

### 1. **–ö–æ–Ω—Å–µ–Ω—Å—É—Å-–∞–ª–≥–æ—Ä–∏—Ç–º—ã –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö**

```python
# –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
extractions = {
    'ocr': ocr_result,
    'gemini': gemini_result,
    'intelligent': intelligent_extractor_result
}

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
consensus_results = quality_enhancer.apply_consensus_algorithm(extractions)
```

### 2. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –æ—Ü–µ–Ω–∫–∏**

```python
class DonutFieldExtractionMetrics:
    def add_document(self, predicted_fields, ground_truth_fields):
        # –¢–æ—á–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –ø–æ–ª—è–º
        # –£—á–µ—Ç —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–¥–µ–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```

### 3. **Data Collator —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∫–∞—á–µ—Å—Ç–≤–∞**

```python
class HighQualityDonutDataCollator:
    def __call__(self, batch):
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∏–∑–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤
        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å task prompt
        # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
```

### 4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**

- **–ë–æ–ª—å—à–µ —ç–ø–æ—Ö** (20 –≤–º–µ—Å—Ç–æ 5) - –º–æ–¥–µ–ª—å –ª—É—á—à–µ —É—á–∏—Ç—Å—è
- **Gradient accumulation** (8 —à–∞–≥–æ–≤) - –±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size
- **–ú–µ–Ω—å—à–∏–π learning rate** (1e-5) - —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
- **–ë–æ–ª—å—à–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ** (448px) - –ª—É—á—à–µ –≤–∏–¥–∏—Ç –¥–µ—Ç–∞–ª–∏
- **Label smoothing** (0.1) - –∏–∑–±–µ–≥–∞–µ–º –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞:

- **F1-score**: > 98%
- **Document accuracy**: > 85% (–∏–¥–µ–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
- **Exact match rate**: > 95%
- **–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏**: < 2 —Å–µ–∫/–¥–æ–∫—É–º–µ–Ω—Ç

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—É—á–µ–Ω–∏—è

–í–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª–µ–π (–Ω–∞ 100 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö):
   üéØ –û–±—â–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (F1): 98.5%
   üìÑ –¢–æ—á–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (100% –ø–æ–ª–µ–π): 87.0%
   ‚úÖ –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: 96.2%
   üìà Precision: 0.987
   üìä Recall: 0.983
   üíé –ö–∞—á–µ—Å—Ç–≤–æ: üèÜ –ü–†–ï–í–û–°–•–û–î–ù–û! –¶–µ–ª–µ–≤–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!
```

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ**: 
- –£–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞—Ç–∞—Å–µ—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: Out of memory
**–†–µ—à–µ–Ω–∏–µ**:
- –£–º–µ–Ω—å—à–∏—Ç–µ batch size
- –í–∫–ª—é—á–∏—Ç–µ gradient checkpointing
- –£–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
**–†–µ—à–µ–Ω–∏–µ**:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ fp16
- –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ beams –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GPU —Å –±–æ–ª—å—à–∏–º –æ–±—ä–µ–º–æ–º –ø–∞–º—è—Ç–∏

## üìù –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ production

```python
# –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
from transformers import DonutProcessor, VisionEncoderDecoderModel

processor = DonutProcessor.from_pretrained("path/to/trained/model")
model = VisionEncoderDecoderModel.from_pretrained("path/to/trained/model")

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
def extract_invoice_fields(image_path):
    image = Image.open(image_path).convert('RGB')
    pixel_values = processor(image, return_tensors="pt").pixel_values
    
    task_prompt = "<s_docvqa><s_question>Extract all fields from the document</s_question><s_answer>"
    decoder_input_ids = processor.tokenizer(task_prompt, add_special_tokens=False, return_tensors="pt").input_ids
    
    outputs = model.generate(
        pixel_values,
        decoder_input_ids=decoder_input_ids,
        max_length=768,
        num_beams=4,
        temperature=0.1
    )
    
    prediction = processor.batch_decode(outputs, skip_special_tokens=True)[0]
    fields = parse_donut_output(prediction)
    
    return fields
```

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–° –ø–æ–º–æ—â—å—é —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å —Ç–æ—á–Ω–æ—Å—Ç–∏ > 98% –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –ø–æ–ª–µ–π –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —É—Å–ø–µ—Ö–∞:

1. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (F1 –ø–æ –ø–æ–ª—è–º, –∞ –Ω–µ BLEU)
2. ‚úÖ –í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∫–æ–Ω—Å–µ–Ω—Å—É—Å–æ–º
3. ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è
4. ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
5. ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö

–£–¥–∞—á–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è! üöÄ 